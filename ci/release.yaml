---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: alpine/git

inputs:
  - name: terraform-src
  - name: vault-release
  - name: release-version

outputs:
  - name: terraform-src-modified

params:
  GIT_AUTHOR_NAME:
  GIT_AUTHOR_EMAIL:
  GIT_COMMITTER_NAME:
  GIT_COMMITTER_EMAIL:
  EMAIL:

run:
  path: sh
  args:
    - -exc
    - |
      git clone terraform-src terraform-src-modified

      VAULT_VERSION=`cat vault-release/version`
      RELEASE_VERSION=`cat release-version/version`
      cd terraform-src-modified

      INITIAL_REFERENCE=`git rev-parse HEAD`

      # Update vault_version default to the provided version
      find ./ -type f -name variables.tf -exec sed -ri '/^variable "vault_version"\s*\{/,+2s/(default\s*=\s*)".*"/\1"'${VAULT_VERSION}'"/' {} \;
      # Update readme with the provided vault version
      sed -ri 's/^(\| vault\\?_version \|.*\|.*\|).*\|.*\|/\1 `"'${VAULT_VERSION}'"` | no |/g' README.md

      git diff --exit-code || git commit -am "[CI] Update vault version to ${VAULT_VERSION}"
      git tag $RELEASE_VERSION
      git checkout $INITIAL_REFERENCE
